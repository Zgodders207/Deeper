<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0D1117">
    <title>deeper</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div id="app"></div>

    <script src="scripts/storage.js"></script>
    <script src="scripts/routines.js"></script>
    <script>
        // Initialize data
        let appData = Storage.load();

        // Router - handles time-based redirects
        function route() {
            const mode = Routines.getCurrentMode();

            switch(mode) {
                case 'pre-morning':
                    showPreMorning();
                    break;

                case 'morning-required':
                    // Redirect to morning routine
                    window.location.href = 'morning-routine.html';
                    break;

                case 'daytime':
                    // Redirect to dashboard
                    window.location.href = 'dashboard.html';
                    break;

                case 'evening-required':
                    // Redirect to evening routine
                    window.location.href = 'evening-routine.html';
                    break;

                case 'evening-complete':
                    showEveningComplete();
                    break;

                default:
                    // Fallback to dashboard
                    window.location.href = 'dashboard.html';
            }
        }

        // Show pre-morning locked screen
        function showPreMorning() {
            const timeUntil = Routines.getTimeUntil(appData.preferences.morningTime || '06:30');

            document.getElementById('app').innerHTML = `
                <div class="container centered" style="min-height: 100vh;">
                    <div class="completion-screen">
                        <div class="completion-icon">ðŸŒ™</div>
                        <div class="completion-title">Too Early</div>
                        <div class="completion-body">
                            Your morning routine starts at ${appData.preferences.morningTime || '06:30'}.<br><br>
                            Time until morning: <strong>${Routines.formatTimeRemaining(timeUntil.hours, timeUntil.minutes)}</strong><br><br>
                            Go back to sleep or rest.
                        </div>
                    </div>
                </div>
            `;

            // Check again in 1 minute
            setTimeout(route, 60000);
        }

        // Show evening complete screen
        function showEveningComplete() {
            document.getElementById('app').innerHTML = `
                <div class="container centered" style="min-height: 100vh;">
                    <div class="completion-screen">
                        <div class="completion-icon">âœ“</div>
                        <div class="completion-title">Day Complete</div>
                        <div class="completion-body">
                            You've completed your evening routine.<br><br>
                            Time to rest.<br><br>
                            See you tomorrow morning.
                        </div>
                        <button class="btn" onclick="showStats()" style="max-width: 300px; margin: var(--space-4) auto;">
                            View Today's Stats
                        </button>
                    </div>
                </div>
            `;

            // Check again in 1 minute (in case it becomes a new day)
            setTimeout(route, 60000);
        }

        // Show today's stats
        function showStats() {
            const today = Storage.getTodayString();
            const completedHabits = appData.habits.filter(h => h.dates.includes(today)).length;
            const totalHabits = appData.habits.length;
            const studyTime = Storage.getTodayStudyTime(appData);

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">Today's Summary</div>

                    <div style="margin: var(--space-6) 0;">
                        <div class="stat-card" style="margin-bottom: var(--space-3);">
                            <div class="stat-value">${completedHabits} / ${totalHabits}</div>
                            <div class="stat-label">Habits Completed</div>
                        </div>

                        <div class="stat-card" style="margin-bottom: var(--space-3);">
                            <div class="stat-value">${studyTime}m</div>
                            <div class="stat-label">Study Time</div>
                        </div>

                        <div class="stat-card" style="margin-bottom: var(--space-3);">
                            <div class="stat-value">${Storage.getHabitStreak(appData, 'morning-routine')}</div>
                            <div class="stat-label">Morning Routine Streak</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-value">${Storage.getHabitStreak(appData, 'evening-routine')}</div>
                            <div class="stat-label">Evening Routine Streak</div>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Close modal
        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }

        // Initialize
        window.onload = function() {
            // Mark first visit
            Routines.isFirstVisitToday();

            // Route to appropriate page
            route();
        };

        // Handle ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>

    <style>
        .stat-card {
            padding: var(--space-4);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 2px;
            text-align: center;
        }

        .stat-value {
            font-size: var(--font-4xl);
            font-weight: 700;
            margin-bottom: var(--space-2);
            font-variant-numeric: tabular-nums;
        }

        .stat-label {
            font-size: var(--font-sm);
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
</body>
</html>
